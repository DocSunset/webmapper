<!DOCTYPE html>
<html>
<head>

<title>LibMapper Hive Plot</title>

<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/LibMapperModel.js"></script>
<script type="text/javascript" src="js/jquery.min.js"></script><!-- JQuery -->
<script type="text/javascript" src="js/viz/hive.js"></script>
<link rel="stylesheet" type="text/css" href="js/viz/hive/HivePlot_style.css" />

<script><!--

var nSrcDevices = 0;
var nDstDevices = 0;

var model, view;

function init(){

	$('#container').css('height', ($(window).height() - 40) + 'px' );
    window.onresize = function (e) {
    	$('#container').css('height', ($(window).height() - 40) + 'px' );
    	view.on_resize();
    };
	
	model = new LibMapperModel();
	view  = new  HivePlotView(document.getElementById("container"), model);
	view.on_resize();

	// controller (from view)  
    $("#container").on("link", function(e, src, dst){
        link(src, dst);
    });
    $("#container").on("unlink", function(e, src, dst){
        unlink(src, dst);
    });
    $("#container").on("connect", function(e, src, dst){
        connect(src, dst);
    });
    $("#container").on("disconnect", function(e, src, dst){
        disconnect(src, dst);
    });
	
	initData();
}

// init with fake data for now
function initData()
{
	var nIn = 4, nOut = 12, nSigs = 10;
	for(var i=0; i<nIn;i++)
		addDevice("/Source " + nSrcDevices++, 0, nSigs);
	for(var i=0; i<nOut;i++)
		addDevice("/Destination " + nDstDevices++, nSigs, 0);
	
	// connect everything
	for(var i=0; i<nSrcDevices; i++){
		for(var j=0; j<nDstDevices; j++){
			link("/Source " + i, "/Destination " + j);
			
			for(var k=0; k<nSigs; k+=1){
				for(var l=0; l<nSigs; l+=3, k+=1){
					var rand = Math.random() * 10;
					if(rand<2){
						connect("/Source " + i + "/Signal" + k, "/Destination " + j + "/Signal" + l);
						k+=3;
					}
				}
			}
		}
	}
	view.update_display();
}

function link(src, dst){
	var key = src + ">" + dst;
	var args = new Object(); 
	args.src_name = src;
	args.dest_name = dst;
	model.links.add(key, args);
	view.update_display();
}
function unlink(src, dst){
	var key = src + ">" + dst;
	model.links.remove(key);
	view.update_display();
}
function connect(src, dst){
	var key = src + ">" + dst;
	var args = new Object(); 
	args.src_name = src;
	args.dest_name = dst;
	args.bound_min = 0;
	args.dest_length = 1;
	args.src_length = 1;
	args.bound_max = 0;
	args.muted = 0;
	args.range = [0.0, 10.0, 0.0, 1.0];
	args.mode = 2;
	args.src_type = 'f';
	args.dest_type = 'f';
	args.expression = 'y=x';
	model.connections.add(key, args);	
}
function disconnect(src, dst){
	var key = src + ">" + dst;
	model.connections.remove(key);
	view.update_display();
}

function addDevice(name, nIn, nOut)
{
/*
	var args = new Array();
	args['name'] = name;
	args['n_inputs'] = 2;
	args['n_outputs'] = 0;
	var device = model.new_device(args);
*/
	var args = new Object();
	args.name = name;
	args.n_inputs = nIn;
	args.n_outputs = nOut;
	model.devices.add(name, args);

	for(var j=0; j<nIn;j++)
		addDevSignal("/Signal" + j, name);	
	for(var j=0; j<nOut;j++)
		addDevSignal("/Signal" + j, name);	
}

function addDevSignal(name, device_name)
{
	/*
	var args = new Array(); 
	args['device_name'] = device_name;
	args['name'] = name;
	var signal = model.new_signal(args);
	*/
	var args = new Object(); 
	args.device_name = device_name;
	args.name = name;
	model.signals.add(device_name+name, args);

}

function btnHandler(val)
{
		if(val=="dst"){
			addDevice("/Destination " + nDstDevices++, 2, 0);
		}else if(val=="src"){
			addDevice("/Source " + nSrcDevices++, 0, 2);		
		}else if(val=="init"){
			initData();		
		}
		view.update_display();
}

--></script>

</head>


<body onload="init()">
<div style="margin: 0 auto; class: topMenu">
	<button onclick="btnHandler('init')">Add 5x5 Devices</button>
	<button onclick="btnHandler('src')">Add Source Device</button>
	<button onclick="btnHandler('dst')">Add Destination Device</button>
</div> 

	<div id="container">


</div>

</body>
</html>